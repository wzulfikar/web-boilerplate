#!/bin/bash

# Note: because we're using environment variables from local file (.env.production-local.secrets),
# we need to update the environment variables in the file and rebuild+deploy again when a secret
# is updated.

bun secrets:decrypt
cp .env.production-local.secrets .env.production.local
bun secrets:encrypt

mkdir /tmp/workdir

# Move directories that should be excluded from the build
if [ -d "./src/app/~dev" ]; then
    echo "[info] moving ~dev directory to temporary workdir"
    mv ./src/app/~dev /tmp/workdir/~dev
fi

# Vercel requires author commit to be team member of the project.
# Update the email to the team member's email.
echo "[info] updating commit author's email"
git config --global user.email "some@email.com"
git config --global user.name "Your Email"
git commit --allow-empty -m "$(git log -1 --pretty=%B)"

NODE_OPTIONS="--max-old-space-size=7000" SKIP_LINT=true SKIP_TYPE_CHECK=true time npx vercel build --prod

# Check if build failed and exit if it did
if [ $? -ne 0 ]; then
    echo "[error] Build failed, stopping deployment"
    exit 1
fi

if [ -n "$VERCEL_TOKEN" ]; then
    time npx vercel deploy --prod --prebuilt --token=$VERCEL_TOKEN
else
    time npx vercel deploy --prod --prebuilt
fi

if [ $? -ne 0 ]; then
    echo "[error] Deployment failed, stopping deployment"
    exit 1
fi
